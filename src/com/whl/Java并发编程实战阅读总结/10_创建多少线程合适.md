# 创建多少线程合适

在Java中，实现并发的主要手段就是多线程，创建线程与对象不同，需要调用操作系统的内核API，为线程分配一系列的资源，这个成本是相当高的。因此创建多少个线程合适就是一个大问题。  

要想提升程序的性能基本上可以通过两个方向，一个是优化算法，另一个就是将硬件的性能发挥到极致。那么如果要通过后者实现性能提升，就需要通过多线程实现。要想将硬件性能发挥到极致，就需要通过并发编程提高IO设备与CPU的利用率。

假设CPU计算与IO操作的耗时是1:1，如果通过单线程执行，CPU计算的时候，IO空闲；IO执行的时候，CPU空闲，因此两者的利用率都是百分之50。
![单线程执行](https://static001.geekbang.org/resource/image/d1/22/d1d7dfa1d574356cc5cb1019a4b7ca22.png)

如果有两个线程同时执行，当线程A在执行IO操作时，线程B执行CPU计算；当线程B在执行IO操作时，线程A执行CPU计算。也就是两者交叉执行，因此利用率就都是百分之百。

![多线程执行](https://static001.geekbang.org/resource/image/68/2c/68a415b31b72844eb81889e9f0eb3f2c.png)

既然增加线程能够使得IO和CPU的利用率都能够提高，那么在IO和CPU的利用率都很低的情况下，可以适当增加线程来提高吞吐量（单位时间内执行请求的数量）。  

在单核CPU时代，多线程主要就是用于平衡IO和CPU的，如果程序只有CPU计算，没有IO操作的话，多线程不但不会提高性能，反而会使得性能变得更差，原因在于一次线程切换是需要一定的成本的。就好比写作业写一会儿停一会儿的效率一定不比一直写的效率高。  

但是在多核CPU时代，这类纯CPU计算的程序也可以通过多线程来提高效率。这时就可以看作你有多个大脑，一个大脑负责计算第一题，另一个大脑负责计算第二题，效率自然成倍增长。  

当今我们的计算机大多都是具备多核CPU的，但创建多少个线程也还是需要通过具体的场景去判断。而这些场景又以IO和CPU执行时长又分为IO密集型和CPU密集型。  

对于CPU密集型，本质上是提高多核CPU的利用率，所以对一个4核的CPU，每个核一个线程，理论上4个线程就能够保证CPU的执行效率是100%的了，再创建更多的线程也只是增加切换线程的成本。但是在工程上，一般线程数量会设置在“CPU核数”+1，这是为了保证某个线程失效或者因为其他原因阻塞时，这个额外的线程可以顶上，从而保证CPU利用率。  

而对于IO密集型，单核CPU的最佳线程数 = 1 + （IO耗时/CPU耗时），例如：IO耗时:CPU耗时 = 4 : 1，那么理论上需要5个线程，4个线程负责IO，1个线程负责CPU计算。再加上额外的一个线程保证突发情况的利用率，因此是6个。而多核CPU的最佳线程数只需要等比扩大即可：CPU 核数 * [ 1 +（I/O耗时/CPU耗时）]
