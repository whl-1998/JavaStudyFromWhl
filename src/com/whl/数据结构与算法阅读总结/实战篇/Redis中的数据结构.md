### Redis

Redis是一种非关系型数据库，相比起mysql支持的各种复杂查询需求，Redis只能通过key来检索value。key的数据类型是字符串，value的数据类型可以有很多种，分别是：字符串、列表、字典、集合、有序集合。正是因为这种简单的存储结构，也使得Redis的读写效率非常高。除此以外，Redis主要作为内存数据库使用，简单来说就是数据存储在内存中，但Redis也支持将数据持久化到硬盘。



### 列表

列表这种数据类型仅支持存储一组数据，它有两种实现的方法，一种是压缩列表、另一种是双向循环链表。当列表中存储的数据量较小时，就可以采用亚索列表的形式实现，具体要求是：

* 列表中的单个数据小于64字节
* 列表中的数据个数小于512个

针对压缩列表，它并不是基础数据结构，而是Redis自己设计的一种数据存储结构，有点类似数组，通过一块连续的内存空间存储数据。但与数组不同的是，它对存储数据的大小和个数都有限制。具体存储结构如下所示：

![img](https://static001.geekbang.org/resource/image/49/b5/49fd8d46eb94f463ace98717f11c2cb5.jpg)

压缩列表，顾名思义就是更加节省内存的列表。之所以说这种数据结构节省内存，是相比起数组的存储思路而言的。我们知道数组要求存储元素的类型相同，并且当我们需要存储不同长度的字符串时，就需要用最大长度的字符串大小作为数组元素的大小（假设是20个字节）。当我们存储小于20个字节的字符串到数组时，就会浪费一部分存储空间。

而压缩列表这种数据结构相比起数组，如果存储小于20个字节的字符串时，就只需要该字符串大小的空间，并且也不限制存储元素的类型相同。除此以外，因为数据存储在一片连续的内存空间，并且通过key获取对应的列表类型数据，读取效率也非常高。

当列表中存储的数据量比较大时，列表就需要通过双向循环链表实现了。



### 字典

字典类型常用于存储一组数据对，每个数据对又包含键值两部分。字典类型也有两种实现方式，一种是压缩列表，另一种是散列表。

同样地，只有当存储的数据量较小的情况下，redis才会使用压缩列表实现字典类型。当不满足压缩列表的限制条件时，才会使用散列表实现字典类型。对于Hash冲突，Redis采用了拉链法解决。除此以外，也支持散列表的动态扩容、缩容机制。

当数据动态增加之后，散列表的装载因子会不断增大，为了避免散列表出现过多哈希冲突的情况，当装载因子大于1时，Redis会触发扩容操作将散列表扩大为之前的2倍左右大小。当散列表中的数据减小，且装载因子小于0.1时会触发缩容操作，将散列表缩小为原来的1/2左右。



### 集合

集合这种数据类型用于存储一组不重复的数据，这种数据类型有两种实现方式，一种是基于有序数组，另一种是基于散列表。

当要存储的数据同时满足如下两个条件时，redis就采用有序数组来实现集合：

* 存储的数据都是整数
* 存储的数据元素个数不超过512

当不同时满足这两个条件时，Redis则采用散列表存储集合中的数据。



### 有序集合

有序集合用来存储一组数据，并且每个数据都附带一个得分，通过得分大小将数据组织成跳表这种数据结构，以支持快速地按照得分值、得分区间获取数据。

当数据量较小时，Redis会采用压缩列表实现有序集合，具体要求是：

* 所有数据的大小都小于64字节
* 元素个数小于128个



### 数据结构持久化

Redis不仅支持内存数据库模式，也支持数据持久化到硬盘，这样就能够使得在断电时保证Redis中的数据不会丢失。当机器重新启动时，只需要从硬盘中的数据重新读取到内存就可以继续工作了。

Redis的数据格式由key、value组成，而value支持多种数据类型，其中字典、集合这种存储结构底层用到了散列表，而散列表中value存储的并不是对象，而是内存地址，那么Redis是如何将一个跟内存地址有关的数据结构持久化到磁盘呢？

主要有两种思路：

1. 清除原有的存储结构，只将数据存储到磁盘，当我们需要从磁盘还原数据到内存时，再重新将数据组织成原来的数据结构。而Redis实际上也是采用了这种持久化思路，只是缺点在于数据从磁盘还原到内存时会消耗较多的时间。例如，我们将散列表的数据存储到磁盘，当我们从磁盘中取出数据重新构建散列表的时候，还需要重新计算每个数据的Hash值。
2. 保留原来的存储格式，将数据按原本的格式存储到磁盘中。例如我们将一个散列表持久化到磁盘，可以将散列表的大小、每个数据被散列的桶位置等信息都保存到磁盘中，有了这些信息，在还原数据到内存的时候就可以避免重新散列的过程。

